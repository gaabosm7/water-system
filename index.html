<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…ÙŠØ§Ù‡ Ø§Ù„Ø¬Ø¹ÙˆØ¯ÙŠØ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #3498db; --green: #2ecc71; --red: #e74c3c; --orange: #f39c12; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f8f9fa; display: flex; flex-direction: column; height: 100vh; }
        
        /* Sidebar Desktop */
        .sidebar { background: var(--dark); width: 250px; transition: 0.3s; display: flex; flex-direction: column; color: white; position: fixed; right: 0; height: 100vh; z-index: 1000; border-left: 1px solid #3e4f5f; }
        .sidebar.collapsed { width: 70px; }
        .menu-btn { padding: 25px; cursor: pointer; text-align: center; color: var(--blue); font-size: 1.8rem; border-bottom: 1px solid #3e4f5f; margin-bottom: 10px; }
        .nav-item { padding: 15px 20px; display: flex; align-items: center; color: #bdc3c7; cursor: pointer; text-decoration: none; white-space: nowrap; overflow: hidden; }
        .nav-item:hover { background: #34495e; color: white; }
        .nav-item i { min-width: 40px; font-size: 1.3rem; text-align: center; }
        .collapsed .nav-item span { display: none; }

        /* Main Content */
        main { margin-right: 250px; padding: 20px; transition: 0.3s; flex: 1; padding-bottom: 80px; }
        .sidebar.collapsed + main { margin-right: 70px; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-card .label { font-size: 1.1rem; margin-bottom: 8px; display: block; opacity: 0.9; }
        .stat-card .value { font-size: 1.8rem; font-weight: bold; }

        /* Table Card */
        .data-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .search-box { position: relative; width: 100%; max-width: 300px; }
        .search-box input { width: 100%; padding: 10px 35px 10px 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        .search-box i { position: absolute; right: 10px; top: 12px; color: #999; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #f1f1f1; text-align: center; }
        th { color: #888; font-weight: 500; }
        .badge-red { color: #e74c3c; font-weight: bold; }

        /* Bottom Nav Mobile */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: none; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .bottom-item { display: flex; flex-direction: column; align-items: center; color: #7f8c8d; font-size: 0.8rem; cursor: pointer; }
        .bottom-item i { font-size: 1.5rem; margin-bottom: 4px; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            main { margin-right: 0 !important; }
            .bottom-nav { display: flex; }
        }
    </style>
</head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <div class="nav-item" onclick="loadDashboard()"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-item" onclick="showUsersReport()"><i class="fas fa-file-invoice"></i><span>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span></div>
        <div class="nav-item" onclick="loadExpenses()"><i class="fas fa-wallet"></i><span>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span></div>
    </nav>

    <main id="content">
        </main>

    <nav class="bottom-nav">
        <div class="bottom-item" onclick="loadDashboard()"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="bottom-item" onclick="showUsersReport()"><i class="fas fa-exchange-alt"></i><span>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span></div>
        <div class="bottom-item" onclick="loadExpenses()"><i class="fas fa-wallet"></i><span>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</span></div>
    </nav>

    <script>
        // ÙˆØ¸ÙŠÙØ© Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }

        // --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù†ÙØ³ Ù…Ø­ØªÙˆÙ‰ ØµÙˆØ±ØªÙƒ) ---
        function loadDashboard() {
            fetch('/dashboard/').then(r => r.json()).then(stats => {
                fetch('/customers/').then(r => r.json()).then(customers => {
                    let html = `
                        <h2 style="color:var(--blue); text-align:center;">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                        <div class="stats-grid">
                            <div class="stat-card" style="background:var(--blue)"><span class="label">Ø§Ù„Ø±ØµÙŠØ¯</span><div class="value">${stats.balance}</div></div>
                            <div class="stat-card" style="background:var(--green)"><span class="label">Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</span><div class="value">${stats.income}</div></div>
                            <div class="stat-card" style="background:var(--red)"><span class="label">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span><div class="value">${stats.expenses}</div></div>
                            <div class="stat-card" style="background:var(--orange)"><span class="label">Ø§Ù„Ø¯ÙŠÙˆÙ†</span><div class="value">${stats.debts}</div></div>
                        </div>
                        <div class="data-card">
                            <div class="table-header">
                                <div style="font-weight:bold;"><i class="fas fa-list"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</div>
                                <div class="search-box"><i class="fas fa-search"></i><input type="text" placeholder="Ø¨Ø­Ø«..." onkeyup="searchTable(this.value)"></div>
                            </div>
                            <table id="mainTable">
                                <thead><tr><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th></tr></thead>
                                <tbody>`;
                    customers.forEach((c, i) => {
                        html += `<tr><td>${i+1}</td><td>${c.full_name}</td><td>${c.phone}</td><td class="${c.wallet_balance < 0 ? 'badge-red' : ''}">${c.wallet_balance}</td></tr>`;
                    });
                    html += `</tbody></table></div>`;
                    document.getElementById('content').innerHTML = html;
                });
            });
        }

        // --- ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª) ---
        function showUsersReport() {
            fetch('/users_report/').then(r => r.json()).then(data => {
                let html = `<h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</h2><div class="data-card"><table>
                    <thead><tr><th>Ø§Ù„Ù…Ø´ØªØ±Ùƒ</th><th>Ø§Ù„Ø¹Ø¯Ø§Ø¯</th><th>Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</th><th>Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th><th>Ø¢Ø®Ø± Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>`;
                data.forEach(u => {
                    html += `<tr><td>${u.full_name}</td><td>${u.serial_number}</td><td>${u.prev_r}</td><td>${u.curr_r}</td><td>${u.last_amount}</td>
                    <td><button onclick="addReading(${u.meter_id})" style="background:var(--green); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer">Ù‚Ø±Ø§Ø¡Ø©</button></td></tr>`;
                });
                html += `</tbody></table></div>`;
                document.getElementById('content').innerHTML = html;
            });
        }

        // --- ÙˆØ¸ÙŠÙØ© Ø¥Ø¶Ø§ÙØ© Ù‚Ø±Ø§Ø¡Ø© ---
        function addReading(meterId) {
            const val = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:");
            if(!val) return;
            fetch('/readings/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({meter_id: meterId, current_reading: parseInt(val)})
            }).then(res => res.json()).then(d => { alert(d.message || d.detail); showUsersReport(); });
        }

        // --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ø·) ---
        function loadExpenses() {
            document.getElementById('content').innerHTML = `<h2>ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2><div class="data-card"><p>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ù†Ø§...</p></div>`;
        }

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø«
        function searchTable(val) {
            let filter = val.toLowerCase();
            let rows = document.querySelectorAll("#mainTable tbody tr");
            rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(filter) ? "" : "none");
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>

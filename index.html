<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body { background-color: #f8f9fa; font-family: 'Tajawal', sans-serif; overflow-x: hidden; }

        /* === Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚) === */
        .sidebar { min-height: 100vh; width: 260px; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); color: white; position: fixed; top: 0; right: 0; padding-top: 50px; z-index: 1050; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.closed { right: -270px; }
        .sidebar h3 { text-align: center; margin-bottom: 30px; color: #3498db; font-weight: 800; font-size: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-top: 15px; }
        .sidebar a { padding: 12px 25px; text-decoration: none; color: #ecf0f1; display: block; transition: all 0.2s; font-size: 15px; margin: 5px 15px; border-radius: 8px; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.15); color: #3498db; transform: translateX(-5px); }
        .sidebar i { margin-left: 10px; width: 25px; text-align: center; }
        .login-btn { margin-top: auto; background: rgba(0,0,0,0.2); cursor: pointer; color: #e74c3c !important; font-weight: bold; }
        .login-btn.logged-in { color: #2ecc71 !important; }
        .main-content { margin-right: 260px; padding: 30px; min-height: 100vh; transition: all 0.3s ease-in-out; }
        .main-content.full-width { margin-right: 0; }
        .toggle-btn { position: fixed; top: 15px; right: 15px; z-index: 1100; background-color: #3498db; color: white; border: none; width: 35px; height: 35px; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .toggle-btn:hover { background-color: #2980b9; transform: scale(1.05); }
        
        @media (max-width: 768px) {
            .sidebar { width: 80%; max-width: 300px; right: -100%; }
            .sidebar.open-mobile { right: 0; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
            .main-content { margin-right: 0 !important; padding: 15px; padding-top: 70px; }
        }

        .stat-card { border-radius: 12px; color: white; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .bg-blue { background: linear-gradient(135deg, #3498db, #2980b9); }
        .bg-green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .bg-red { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .bg-orange { background: linear-gradient(135deg, #f39c12, #d35400); }
        .table-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.03); }
        .table-responsive { overflow-x: auto; }
        .table { min-width: 600px; } 
        .table thead th { background-color: #f8f9fa; border-bottom: 2px solid #eee; color: #555; font-size: 14px; white-space: nowrap; }
        .table tbody td { vertical-align: middle; white-space: nowrap; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display:flex; justify-content:center; align-items:center; z-index: 2000; padding: 20px; }
        .modal-card { background: white; padding: 25px; border-radius: 16px; width: 100%; max-width: 450px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .camera-btn { cursor: pointer; display: block; background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border: 2px dashed #cbd5e0; color: #718096; transition: 0.2s; }
        .footer-text { text-align: center; margin-top: 40px; padding-top: 20px; color: #a0aec0; font-size: 13px; border-top: 1px solid #edf2f7; }

        /* =========================================
           ğŸ–¨ï¸ ØªØµÙ…ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)
           ========================================= */
        #printable-area { display: none; } /* Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ */

        @media print {
            body * { visibility: hidden; } /* Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
            #printable-area, #printable-area * { visibility: visible; } /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙ‚Ø· */
            #printable-area {
                position: absolute; left: 0; top: 0; width: 100%;
                background: white; padding: 20px; display: block !important;
                color: black;
            }
            /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø© */
            .invoice-box {
                max-width: 80mm; /* Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ø«Ù„ Ø§Ù„ÙƒØ§Ø´ÙŠØ±) */
                margin: auto; padding: 10px;
                border: 2px dashed #333;
                font-family: 'Tajawal', sans-serif;
                text-align: center;
            }
            .invoice-header { font-weight: bold; font-size: 18px; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; }
            .invoice-details { text-align: right; margin: 15px 0; font-size: 14px; }
            .invoice-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dotted #ccc; }
            .invoice-total { font-weight: bold; font-size: 16px; border-top: 2px solid #000; margin-top: 10px; padding-top: 5px; }
            .invoice-footer { margin-top: 15px; font-size: 12px; text-align: center; }
            
            /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø­Ø¨Ø± */
            .btn, .sidebar, .toggle-btn { display: none !important; }
        }
    </style>
</head>
<body>

<div id="app">
    
    <div id="printable-area">
        <div class="invoice-box">
            <div class="invoice-header">
                <i class="fas fa-faucet"></i> Ù…Ø´Ø±ÙˆØ¹ Ù…ÙŠØ§Ù‡ Ø§Ù„Ù‚Ø±ÙŠØ©<br>
                <small>{{ receiptData.type === 'invoice' ? 'ÙØ§ØªÙˆØ±Ø© Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ' : 'Ø³Ù†Ø¯ Ù‚Ø¨Ø¶' }}</small>
            </div>
            
            <div class="text-center mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ®: {{ new Date().toLocaleDateString('ar-EG') }}</div>
            
            <div class="invoice-details">
                <div class="invoice-row"><span>Ø§Ù„Ù…Ø´ØªØ±Ùƒ:</span> <strong>{{ receiptData.customer_name }}</strong></div>
                
                <div v-if="receiptData.type === 'invoice'">
                    <div class="invoice-row"><span>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</span> <span>{{ receiptData.prev_reading }}</span></div>
                    <div class="invoice-row"><span>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span> <span>{{ receiptData.curr_reading }}</span></div>
                    <div class="invoice-row"><span>Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ:</span> <span>{{ receiptData.consumption }} ÙˆØ­Ø¯Ø©</span></div>
                    <div class="invoice-row"><span>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</span> <span>100 Ø±ÙŠØ§Ù„</span></div>
                </div>

                <div v-if="receiptData.type === 'payment'">
                    <div class="invoice-row"><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span> <span>{{ receiptData.amount }} Ø±ÙŠØ§Ù„</span></div>
                </div>

                <div class="invoice-total">
                    <div class="invoice-row">
                        <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                        <span>{{ receiptData.total_amount }} Ø±ÙŠØ§Ù„</span>
                    </div>
                </div>
                
                <div class="invoice-row mt-2 text-danger" v-if="receiptData.new_balance < 0">
                    <span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¯ÙŠÙ†):</span>
                    <span>{{ receiptData.new_balance }} Ø±ÙŠØ§Ù„</span>
                </div>
                <div class="invoice-row mt-2 text-success" v-else>
                    <span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ù„Ù‡):</span>
                    <span>{{ receiptData.new_balance }} Ø±ÙŠØ§Ù„</span>
                </div>
            </div>

            <div class="invoice-footer">
                Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ù„ØªØ²Ø§Ù…ÙƒÙ… Ø¨Ø§Ù„Ø³Ø¯Ø§Ø¯<br>
                ØªØ·ÙˆÙŠØ±: Ù…Ø­Ù…Ø¯ Ø¬Ø¹Ø¨ÙˆØ³
            </div>
        </div>
    </div>
    <button class="toggle-btn" @click="toggleSidebar">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar" :class="{ 'closed': !isSidebarOpen, 'open-mobile': isSidebarOpen }">
        <h3><i class="fas fa-hand-holding-water"></i> Ù…ÙŠØ§Ù‡ Ø§Ù„Ù‚Ø±ÙŠØ©</h3>
        <a href="#" :class="{active: currentPage === 'dashboard'}" @click="navTo('dashboard')"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="#" :class="{active: currentPage === 'customers'}" @click="navTo('customers')"><i class="fas fa-users"></i> Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</a>
        <a href="#" :class="{active: currentPage === 'meters'}" @click="navTo('meters')"><i class="fas fa-tachometer-alt"></i> Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
        <a href="#" :class="{active: currentPage === 'expenses'}" @click="navTo('expenses')"><i class="fas fa-wallet"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</a>
        
        <a href="#" @click="toggleAdmin" class="login-btn" :class="{'logged-in': isAdmin}">
            <i class="fas" :class="isAdmin ? 'fa-unlock' : 'fa-lock'"></i>
            {{ isAdmin ? 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±' : 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¯ÙŠØ±' }}
        </a>
    </div>

    <div class="main-content" :class="{ 'full-width': !isSidebarOpen }">
        
        <div v-if="currentPage === 'dashboard'">
            <h2 class="mb-4 text-primary fw-bold fs-4">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
            <div class="row mb-4 g-3">
                <div class="col-12 col-md-6 col-lg-3"><div class="stat-card bg-blue"><h5><i class="fas fa-box"></i> Ø§Ù„Ø±ØµÙŠØ¯</h5><h2 dir="ltr">{{ stats.box_balance }} Ø±ÙŠØ§Ù„</h2></div></div>
                <div class="col-12 col-md-6 col-lg-3"><div class="stat-card bg-green"><h5><i class="fas fa-arrow-down"></i> Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</h5><h2 dir="ltr">{{ stats.total_income }} Ø±ÙŠØ§Ù„</h2></div></div>
                <div class="col-12 col-md-6 col-lg-3"><div class="stat-card bg-red"><h5><i class="fas fa-arrow-up"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h5><h2 dir="ltr">{{ stats.total_expenses }} Ø±ÙŠØ§Ù„</h2></div></div>
                <div class="col-12 col-md-6 col-lg-3"><div class="stat-card bg-orange"><h5><i class="fas fa-exclamation-circle"></i> Ø§Ù„Ø¯ÙŠÙˆÙ†</h5><h2 dir="ltr">{{ stats.total_debts }} Ø±ÙŠØ§Ù„</h2></div></div>
            </div>
            <div class="table-container">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                    <h5 class="m-0 fw-bold"><i class="fas fa-list text-primary"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h5>
                    <div class="input-group" style="max-width: 300px; width: 100%;">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input v-model="searchQuery" class="form-control border-start-0" placeholder="Ø¨Ø­Ø«...">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead><tr><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th></tr></thead>
                        <tbody>
                            <tr v-for="(c, index) in filteredCustomers" :key="c.id">
                                <td>{{ index + 1 }}</td>
                                <td class="fw-bold">{{ c.full_name }}</td>
                                <td>{{ c.phone }}</td>
                                <td>
                                    <span v-if="c.wallet_balance < 0" class="badge bg-danger rounded-pill">{{ c.wallet_balance }}</span>
                                    <span v-else-if="c.wallet_balance > 0" class="badge bg-success rounded-pill">+{{ c.wallet_balance }}</span>
                                    <span v-else class="badge bg-secondary rounded-pill">0</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div v-if="currentPage === 'customers'">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
                <h2 class="text-primary fw-bold fs-4 m-0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
                <button class="btn btn-primary px-3 rounded-pill shadow-sm btn-sm" @click="openAddCustomerModal"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ</button>
            </div>
            <div class="table-container">
                <div class="mb-3"><input v-model="searchQuery" class="form-control" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ©..."></div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody>
                            <tr v-for="c in filteredCustomers" :key="c.id">
                                <td>{{ c.full_name }}</td>
                                <td>{{ c.phone }}</td>
                                <td>
                                    <span v-if="c.wallet_balance < 0" class="badge bg-danger">{{ c.wallet_balance }}</span>
                                    <span v-else-if="c.wallet_balance > 0" class="badge bg-success">+{{ c.wallet_balance }}</span>
                                    <span v-else class="badge bg-secondary">0</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary mx-1" @click="openActionModal(c, 'read')"><i class="fas fa-pen"></i> Ù‚Ø±Ø§Ø¡Ø©</button>
                                    <button class="btn btn-sm btn-outline-success mx-1" @click="openActionModal(c, 'pay')"><i class="fas fa-hand-holding-usd"></i> Ù‚Ø¨Ø¶</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div v-if="currentPage === 'meters'">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
                <h2 class="text-primary fw-bold fs-4 m-0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                <button class="btn btn-dark px-3 rounded-pill shadow-sm btn-sm" @click="openAddMeterModal"><i class="fas fa-plus"></i> Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</button>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>ID</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ</th><th>Ø§Ù„ØªØ³Ù„Ø³Ù„</th><th>Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                        <tbody>
                            <tr v-for="m in meters" :key="m.id">
                                <td>{{ m.id }}</td>
                                <td class="fw-bold text-primary">{{ getCustomerName(m.customer_id) }}</td>
                                <td class="fw-bold">{{ m.serial_number }}</td>
                                <td class="text-primary fw-bold">{{ m.last_reading }}</td>
                                <td>
                                    <button class="btn btn-sm btn-info text-white mx-1" @click="openEditMeterModal(m)"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-warning mx-1" @click="resetMeter(m.id)"><i class="fas fa-redo"></i></button>
                                    <button class="btn btn-sm btn-danger mx-1" @click="deleteMeter(m.id)"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div v-if="currentPage === 'expenses'">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
                <h2 class="text-primary fw-bold fs-4 m-0">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
                <button class="btn btn-danger px-3 rounded-pill shadow-sm btn-sm" @click="openAddExpenseModal"><i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                        <tbody>
                            <tr v-for="ex in expensesList" :key="ex.id">
                                <td>{{ new Date(ex.expense_date).toLocaleDateString('ar-EG') }}</td>
                                <td>{{ ex.title }}</td>
                                <td class="fw-bold text-danger">{{ ex.amount }} Ø±ÙŠØ§Ù„</td>
                                <td>
                                    <a v-if="ex.image_path" :href="api + '/' + ex.image_path" target="_blank" class="btn btn-sm btn-outline-secondary rounded-pill"><i class="fas fa-image"></i> Ø¹Ø±Ø¶</a>
                                    <span v-else class="text-muted text-small">Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary mx-1" @click="openEditExpenseModal(ex)"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger mx-1" @click="deleteExpense(ex.id)"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer-text">ØªØ·ÙˆÙŠØ± Ù…Ø­Ù…Ø¯ Ø¬Ø¹Ø¨ÙˆØ³ &copy; 2026</div>
    </div>

    <div v-if="showLoginModal" class="modal-overlay">
        <div class="modal-card">
            <h4 class="text-center mb-4">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h4>
            <p class="text-muted text-center mb-4">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…</p>
            <input type="password" v-model="loginPassword" class="form-control mb-4 text-center" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <div class="d-flex gap-2">
                <button @click="verifyAdmin" class="btn btn-success flex-grow-1">Ø¯Ø®ÙˆÙ„</button>
                <button @click="showLoginModal=false" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div v-if="showEditExpenseModal" class="modal-overlay"><div class="modal-card"><h4 class="mb-4 text-center">ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h4><label class="form-label">Ø¨ÙŠØ§Ù† Ø§Ù„ØµØ±Ù</label><input v-model="editExpenseData.title" class="form-control mb-2"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label><input v-model="editExpenseData.amount" type="number" class="form-control mb-3"><label class="camera-btn mb-3"><i class="fas fa-camera fa-2x mb-2"></i><br><span>ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</span><input type="file" ref="expenseFile" accept="image/*" capture="environment" hidden @change="handleFileUpload"></label><div class="d-flex gap-2"><button @click="submitEditExpense" class="btn btn-primary flex-grow-1">Ø­ÙØ¸</button><button @click="showEditExpenseModal=false" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div v-if="showEditMeterModal" class="modal-overlay"><div class="modal-card"><h4 class="mb-4 text-center">ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯</h4><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ (ID)</label><input :value="editMeterData.id" class="form-control mb-3 bg-light" disabled><label class="form-label">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><input v-model="editMeterData.new_reading" type="number" class="form-control mb-4"><div class="d-flex gap-2"><button @click="submitEditMeter" class="btn btn-info text-white flex-grow-1">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button><button @click="showEditMeterModal=false" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div v-if="showActionModal" class="modal-overlay"><div class="modal-card"><h4 class="text-center mb-3 fw-bold text-primary">{{ actionType == 'read' ? 'ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø©' : 'Ø³Ù†Ø¯ Ù‚Ø¨Ø¶' }}</h4><p class="text-center mb-4 text-muted">Ø§Ù„Ù…Ø´ØªØ±Ùƒ: <strong>{{ activeCustomer.full_name }}</strong></p><div v-if="actionType == 'read'"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</label><input v-model="readingData.meter_id" class="form-control mb-2 bg-light text-center fw-bold" disabled><label class="form-label">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label><input v-model="readingData.current_reading" type="number" class="form-control mb-4 border-primary" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ù‡Ù†Ø§"></div><div v-if="actionType == 'pay'"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…</label><input v-model="paymentData.amount" type="number" class="form-control mb-4 border-success" placeholder="Ø±ÙŠØ§Ù„"></div><div class="d-flex gap-2"><button @click="submitAction" class="btn flex-grow-1" :class="actionType=='read'?'btn-primary':'btn-success'">ØªØ£ÙƒÙŠØ¯ ÙˆØ·Ø¨Ø§Ø¹Ø©</button><button @click="showActionModal=false" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div v-if="showExpenseModal" class="modal-overlay"><div class="modal-card"><h4 class="mb-4 text-center">Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h4><label class="form-label">Ø¨ÙŠØ§Ù† Ø§Ù„ØµØ±Ù</label><input v-model="newExpense.title" class="form-control mb-2"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label><input v-model="newExpense.amount" type="number" class="form-control mb-3"><label class="camera-btn mb-3"><i class="fas fa-camera fa-2x mb-2"></i><br><span>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span><input type="file" ref="expenseFile" accept="image/*" capture="environment" hidden @change="handleFileUpload"></label><div v-if="previewImage" class="text-center mb-3"><img :src="previewImage" style="max-height: 80px; border-radius: 8px;"></div><div class="d-flex gap-2"><button @click="submitExpense" class="btn btn-danger flex-grow-1">Ø­ÙØ¸</button><button @click="showExpenseModal=false" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div v-if="showAddCustomerModal" class="modal-overlay"><div class="modal-card"><h4 class="mb-4 text-center">Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</h4><input v-model="newCustomer.full_name" class="form-control mb-3" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ"><input v-model="newCustomer.phone" class="form-control mb-4" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"><div class="d-flex gap-2"><button @click="addCustomer" class="btn btn-primary flex-grow-1">Ø­ÙØ¸</button><button @click="showAddCustomerModal=false" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div v-if="showAddMeterModal" class="modal-overlay"><div class="modal-card"><h4 class="mb-4 text-center">Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</h4><select v-model="newMeter.customer_id" class="form-select mb-3"><option v-for="c in customers" :value="c.id">{{ c.full_name }}</option></select><input v-model="newMeter.serial_number" class="form-control mb-3" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ (Ù…Ø«Ù„Ø§Ù‹: 005892)"><input v-model="newMeter.last_reading" type="number" class="form-control mb-4" placeholder="Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©"><div class="d-flex gap-2"><button @click="addMeter" class="btn btn-dark flex-grow-1">Ø­ÙØ¸</button><button @click="showAddMeterModal=false" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>

</div>

<script>
    new Vue({
        el: '#app',
        data: {
            api: '', // Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù…Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
            currentPage: 'dashboard', searchQuery: '', isSidebarOpen: true,
            isAdmin: false, showLoginModal: false, loginPassword: '',
            
            stats: {}, customers: [], meters: [], expensesList: [],
            
            showActionModal: false, showExpenseModal: false, showAddCustomerModal: false, 
            showAddMeterModal: false, showEditMeterModal: false, showEditExpenseModal: false,

            activeCustomer: null, actionType: '',
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
            receiptData: { type: '', customer_name: '', amount: 0, prev_reading: 0, curr_reading: 0, consumption: 0, total_amount: 0, new_balance: 0 },

            paymentData: { amount: '' },
            readingData: { meter_id: '', current_reading: '' },
            editMeterData: { id: '', new_reading: '' },
            editExpenseData: { id: '', title: '', amount: '' },

            newCustomer: { full_name: '', phone: '' },
            newMeter: { customer_id: '', serial_number: '', last_reading: 0 },
            newExpense: { title: '', amount: '' },
            expenseFile: null, previewImage: null
        },
        computed: {
            filteredCustomers() {
                if(this.searchQuery){ return this.customers.filter(c => c.full_name.includes(this.searchQuery) || c.phone.includes(this.searchQuery)); }
                return this.customers;
            }
        },
        mounted() {
            this.loadAllData();
            if (window.innerWidth < 768) { this.isSidebarOpen = false; }
        },
        methods: {
            checkAuth() {
                if (!this.isAdmin) {
                    alert("â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙ…ØªÙ„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!\nÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.");
                    return false;
                }
                return true;
            },
            openAddCustomerModal() { if(this.checkAuth()) this.showAddCustomerModal = true; },
            openAddMeterModal() { if(this.checkAuth()) this.showAddMeterModal = true; },
            openAddExpenseModal() { if(this.checkAuth()) this.showExpenseModal = true; },
            
            openActionModal(customer, type) {
                if(!this.checkAuth()) return;
                this.activeCustomer = customer; this.actionType = type; this.showActionModal = true;
                this.paymentData.amount = ''; this.readingData.current_reading = ''; this.readingData.meter_id = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
                if (type === 'read') {
                    axios.get(this.api + '/customer_meter/' + customer.id).then(res => {
                        if (res.data.status === 'no_meter') { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø¯Ø§Ø¯'); this.showActionModal = false; }
                        else { 
                            this.readingData.meter_id = res.data.meter_id;
                            // Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                            this.receiptData.prev_reading = this.meters.find(m => m.id == res.data.meter_id)?.last_reading || 0;
                        }
                    });
                }
            },
            
            openEditMeterModal(meter) { if(!this.checkAuth()) return; this.editMeterData.id = meter.id; this.editMeterData.new_reading = meter.last_reading; this.showEditMeterModal = true; },
            openEditExpenseModal(expense) { if(!this.checkAuth()) return; this.editExpenseData = { id: expense.id, title: expense.title, amount: expense.amount }; this.expenseFile = null; this.showEditExpenseModal = true; },
            deleteExpense(id) { if(!this.checkAuth()) return; if(confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) axios.delete(this.api + '/expenses/' + id).then(() => { alert('ØªÙ…'); this.loadAllData(); }); },
            resetMeter(id) { if(!this.checkAuth()) return; if(confirm('ØªØµÙÙŠØ±ØŸ')) axios.put(this.api + '/meters/' + id + '/reset').then(() => { alert('ØªÙ…'); this.loadAllData(); }); },
            deleteMeter(id) { if(!this.checkAuth()) return; if(confirm('Ø­Ø°ÙØŸ')) axios.delete(this.api + '/meters/' + id).then(() => { alert('ØªÙ…'); this.loadAllData(); }); },

            toggleAdmin() { if (this.isAdmin) { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) { this.isAdmin = false; alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬."); } } else { this.showLoginModal = true; this.loginPassword = ''; } },
            verifyAdmin() { if (this.loginPassword === '123456') { this.isAdmin = true; this.showLoginModal = false; alert("âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ Ù…Ø¯ÙŠØ±!"); } else { alert("âŒ Ø®Ø·Ø£!"); } },

            loadAllData() {
                axios.get(this.api + '/dashboard/').then(res => this.stats = res.data);
                axios.get(this.api + '/customers/').then(res => this.customers = res.data);
                axios.get(this.api + '/meters/').then(res => this.meters = res.data);
                axios.get(this.api + '/expenses/').then(res => this.expensesList = res.data);
            },
            toggleSidebar() { this.isSidebarOpen = !this.isSidebarOpen; },
            navTo(page) { this.currentPage = page; if (window.innerWidth < 768) { this.isSidebarOpen = false; } },
            getCustomerName(id) { const customer = this.customers.find(c => c.id === id); return customer ? customer.full_name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'; },

            // ğŸ–¨ï¸ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            submitAction() {
                this.receiptData.customer_name = this.activeCustomer.full_name;

                if (this.actionType === 'pay') {
                    // Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹ (Ø³Ù†Ø¯ Ù‚Ø¨Ø¶)
                    axios.post(this.api + '/payments/', { customer_id: this.activeCustomer.id, amount: parseFloat(this.paymentData.amount) })
                    .then(res => {
                        this.receiptData.type = 'payment';
                        this.receiptData.amount = this.paymentData.amount;
                        this.receiptData.total_amount = this.paymentData.amount;
                        this.receiptData.new_balance = res.data.new_balance;
                        
                        this.showActionModal = false; 
                        this.loadAllData();
                        
                        // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                        setTimeout(() => window.print(), 500);
                    });
                } else {
                    // Ø¹Ù…Ù„ÙŠØ© Ù‚Ø±Ø§Ø¡Ø© (ÙØ§ØªÙˆØ±Ø©)
                    axios.post(this.api + '/readings/', { meter_id: parseInt(this.readingData.meter_id), current_reading: parseInt(this.readingData.current_reading) })
                    .then(res => {
                        this.receiptData.type = 'invoice';
                        this.receiptData.curr_reading = this.readingData.current_reading;
                        this.receiptData.consumption = res.data.units;
                        this.receiptData.total_amount = res.data.cost;
                        this.receiptData.new_balance = res.data.new_balance;
                        
                        this.showActionModal = false; 
                        this.loadAllData();
                        
                        // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                        setTimeout(() => window.print(), 500);
                    }).catch(err => alert(err.response.data.detail));
                }
            },

            // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„
            submitEditExpense() {
                let formData = new FormData(); formData.append('title', this.editExpenseData.title); formData.append('amount', this.editExpenseData.amount);
                if (this.expenseFile) formData.append('file', this.expenseFile);
                axios.put(this.api + '/expenses/' + this.editExpenseData.id, formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(() => { alert('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); this.showEditExpenseModal = false; this.loadAllData(); });
            },
            submitEditMeter() { axios.put(this.api + '/meters/' + this.editMeterData.id, { last_reading: parseInt(this.editMeterData.new_reading) }).then(() => { alert('âœ… ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø±ØµÙŠØ¯'); this.showEditMeterModal = false; this.loadAllData(); }); },
            addCustomer() { axios.post(this.api + '/customers/', this.newCustomer).then(() => { alert('ØªÙ…'); this.showAddCustomerModal=false; this.loadAllData(); }); },
            handleFileUpload(event) { this.expenseFile = event.target.files[0]; if (this.expenseFile) this.previewImage = URL.createObjectURL(this.expenseFile); },
            submitExpense() {
                if (!this.newExpense.title || !this.newExpense.amount) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
                let formData = new FormData(); formData.append('title', this.newExpense.title); formData.append('amount', this.newExpense.amount);
                if (this.expenseFile) formData.append('file', this.expenseFile);
                axios.post(this.api + '/expenses/', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(() => { alert('ØªÙ…'); this.showExpenseModal = false; this.newExpense={title:'',amount:''}; this.loadAllData(); }).catch(err => alert("Ø®Ø·Ø£"));
            },
            addMeter() { axios.post(this.api + '/meters/', this.newMeter).then(() => { alert('ØªÙ…'); this.showAddMeterModal=false; this.loadAllData(); }); }
        }
    });
</script>
</body>
</html>